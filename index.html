<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minewall - Telegram Mini App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
        color: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow-x: hidden;
    }

    .container {
        max-width: 480px;
        margin: 0 auto;
        padding: 10px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 10px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 15px;
        margin-bottom: 10px;
        position: relative;
    }

    .menu-button, .back-button {
        background: #4e54c8;
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .daily-bonus {
        background: linear-gradient(to right, #ff8a00, #da1b60);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .game-title {
        text-align: center;
        font-size: 28px;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        margin: 10px 0;
        letter-spacing: 1px;
    }

    .page {
        display: none;
        flex: 1;
        flex-direction: column;
    }

    .page.active {
        display: flex;
    }

    .ad-container {
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
        padding: 10px;
        margin: 10px 0;
        text-align: center;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .ad-label {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255,255,255,0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
    }

    .start-button {
        background: linear-gradient(to right, #00c9ff, #92fe9d);
        border: none;
        color: #1a2a6c;
        padding: 20px 40px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 50px;
        margin: 20px auto;
        cursor: pointer;
        box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        transition: all 0.3s;
    }

    .start-button:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }

    .username-display {
        text-align: center;
        font-size: 18px;
        margin-top: 15px;
        background: rgba(255,255,255,0.1);
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
        margin-left: auto;
        margin-right: auto;
    }

    .game-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin: 20px auto;
        width: 100%;
        max-width: 350px;
    }

    .cell {
        aspect-ratio: 1/1;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .cell::before {
        content: "?";
        position: absolute;
        font-size: 24px;
        color: rgba(255,255,255,0.7);
    }

    .cell.revealed {
        background: rgba(255, 255, 255, 0.4);
    }

    .cell.revealed::before {
        display: none;
    }

    .cell.mine {
        background: #ff464d;
    }

    .cell.diamond {
        background: #4dffb8;
    }

    .stats-bar {
        display: flex;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.7);
        padding: 12px;
        border-radius: 15px;
        margin: 10px 0;
    }

    .stat-item {
        text-align: center;
    }

    .stat-label {
        font-size: 12px;
        opacity: 0.8;
    }

    .stat-value {
        font-size: 18px;
        font-weight: bold;
    }

    .game-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        gap: 10px;
    }

    .control-button {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .skip-ad {
        background: linear-gradient(to right, #ff8a00, #e52e71);
    }

    .skip-coin {
        background: linear-gradient(to right, #00b09b, #96c93d);
    }

    .restart {
        background: linear-gradient(to right, #1d976c, #93f9b9);
    }

    .withdraw-form {
        background: rgba(0, 0, 0, 0.6);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .input-group input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.9);
    }

    .submit-button {
        background: linear-gradient(to right, #00c9ff, #92fe9d);
        border: none;
        color: #1a2a6c;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 10px;
        width: 100%;
        cursor: pointer;
        margin-top: 10px;
    }

    .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background: linear-gradient(to right, #00c9ff, #92fe9d);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 10px;
        overflow: hidden;
        top: 50px;
        left: 0;
    }

    .dropdown-content button {
        color: white;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
    }

    .dropdown-content button:hover {
        background: rgba(78, 84, 200, 0.7);
    }

    .dropdown.show .dropdown-content {
        display: block;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f); 
        padding: 30px; 
        border-radius: 20px; 
        text-align: center; 
        max-width: 90%; 
        width: 350px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .modal h2 {
        font-size: 28px;
        margin-bottom: 20px;
        color: #fff;
    }

    .modal p {
        font-size: 18px;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .modal-button {
        background: linear-gradient(to right, #00c9ff, #92fe9d);
        border: none;
        color: #1a2a6c;
        padding: 12px 25px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 30px;
        cursor: pointer;
        margin: 0 5px;
        transition: all 0.3s;
    }

    .modal-button:hover {
        transform: scale(1.05);
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-20px);}
        60% {transform: translateY(-10px);}
    }

    .bounce {
        animation: bounce 1s;
    }

    @keyframes diamondGlow {
        0% { box-shadow: 0 0 5px #4dffb8; }
        50% { box-shadow: 0 0 20px #4dffb8; }
        100% { box-shadow: 0 0 5px #4dffb8; }
    }

    .diamond-glow {
        animation: diamondGlow 1.5s infinite;
    }

    .footer {
        text-align: center;
        padding: 15px;
        font-size: 12px;
        opacity: 0.7;
    }

    .channel-restriction {
        text-align: center;
        padding: 30px 20px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 20px;
        margin: 20px 0;
    }

    .channel-restriction h2 {
        margin-bottom: 20px;
        color: #ff8a00;
    }

    .channel-restriction p {
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .join-button {
        background: linear-gradient(to right, #00c9ff, #92fe9d);
        border: none;
        color: #1a2a6c;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 30px;
        cursor: pointer;
        margin: 10px 0;
        display: inline-block;
        text-decoration: none;
    }

    .channel-icon {
        font-size: 60px;
        color: #4dffb8;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
    }

    .check-membership {
        background: #4e54c8;
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        margin-top: 15px;
    }

    @media (max-width: 480px) {
        .game-grid {
            gap: 6px;
        }
        .control-button {
            font-size: 14px;
            padding: 10px;
        }
        .game-title {
            font-size: 24px;
        }
        .start-button {
            padding: 15px 30px;
            font-size: 20px;
        }
    }
    </style>
</head>
<body>
<div class="container">
    <!-- Restriction Page (shown by default) -->
    <div id="restrictionPage" class="page active">
        <div class="game-title">Minewall</div>

        <div class="channel-restriction">
            <div class="channel-icon">
                <i class="fab fa-telegram"></i>
            </div>
            <h2>Join Our Telegram Channel</h2>
            <p>To access this game and start earning rewards, you need to join our official Telegram channel.</p>
            <p>This helps us build a community and provide updates about the game.</p>

            <a href="https://t.me/your_channel" class="join-button" target="_blank">
                <i class="fab fa-telegram"></i> Join Channel
            </a>

            <p style="margin-top: 20px;">After joining, click the button below to verify and access the game:</p>
            <button class="check-membership" onclick="checkChannelMembership()">
                <i class="fas fa-check-circle"></i> I've Joined the Channel
            </button>
        </div>

        <div class="ad-container">
            <div class="ad-label">AD</div>
            <div id="topAd">Advertisement Space</div>
        </div>
    </div>

    <!-- Home Page (shown after joining channel) -->
    <div id="homePage" class="page">
        <div class="header">
            <div class="dropdown" id="dropdownMenu">
                <button class="menu-button">‚â°</button>
                <div class="dropdown-content">
                    <button onclick="showPage('withdraw')">Withdraw</button>
                    <button onclick="showPage('settings')">Settings</button>
                </div>
            </div>
            <div class="game-title">Minewall</div>
            <button class="daily-bonus" onclick="claimDailyBonus()">Daily Bonus</button>
        </div>

        <div class="ad-container">
            <div class="ad-label">AD</div>
            <div id="topAd">Advertisement Space</div>
        </div>

        <h1 class="game-title">MINEWALL</h1>
        <div class="username-display">Welcome, Player!</div>
        <button class="start-button pulse" onclick="startGame()">START GAME</button>

        <div class="ad-container">
            <div class="ad-label">AD</div>
            <div id="bottomAd">Advertisement Space</div>
        </div>

        <div class="footer">
            Minewall Mini App ¬© 2023 | Play and Earn
        </div>
    </div>

    <!-- Game Page -->
    <div id="gamePage" class="page">
        <div class="header">
            <button class="back-button" onclick="showPage('home')">‚Üê</button>
            <div class="game-title">Level: <span id="currentLevel">1</span></div>
            <div></div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">COINS</div>
                <div class="stat-value" id="coinDisplay">300</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">USD BALANCE</div>
                <div class="stat-value" id="usdDisplay">$0.00</div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">TIME</div>
                <div class="stat-value" id="timerDisplay">00:00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">DIAMONDS FOUND</div>
                <div class="stat-value" id="diamondsFound">0/4</div>
            </div>
        </div>

        <div class="game-grid" id="gameGrid"></div>

        <div class="game-controls">
            <button class="control-button skip-ad" onclick="skipWithAd()">
                <i class="fas fa-ad"></i> Skip with Ad
            </button>
            <button class="control-button skip-coin" onclick="skipWithCoins()">
                <i class="fas fa-coins"></i> Skip with Coins
            </button>
            <button class="control-button restart" onclick="restartLevel()">
                <i class="fas fa-redo"></i> Restart
            </button>
        </div>

        <div class="ad-container">
            <div class="ad-label">AD</div>
            <div id="bottomAd">Advertisement Space</div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <h2>Congratulations!</h2>
            <p>You found all diamonds and completed the level!</p>
            <p>Reward: +$0.05 USD</p>
            <button class="modal-button" onclick="nextLevel()">Next Level</button>
        </div>
    </div>

    <div class="modal" id="loseModal">
        <div class="modal-content">
            <h2>Game Over!</h2>
            <p>You hit a mine. Try again or skip the level.</p>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button class="modal-button" style="background: linear-gradient(to right, #ff8a00, #e52e71);" onclick="skipWithAd()">Skip with Ad</button>
                <button class="modal-button" style="background: linear-gradient(to right, #00b09b, #96c93d);" onclick="skipWithCoins()">Skip with Coins</button>
                <button class="modal-button" style="background: linear-gradient(to right, #1d976c, #93f9b9);" onclick="restartLevel()">Restart Level</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dailyBonusModal">
        <div class="modal-content">
            <h2>Daily Bonus!</h2>
            <p>You received 5 coins!</p>
            <button class="modal-button" onclick="closeModal('dailyBonusModal')">Claim</button>
        </div>
    </div>

    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <h2>Withdrawal Requested</h2>
            <p>Your withdrawal request has been submitted. Please allow 24-48 hours for processing.</p>
            <button class="modal-button" onclick="closeModal('withdrawModal')">OK</button>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="backgroundMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mpeg">
    </audio>
    <audio id="clickSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>
    <audio id="winSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="loseSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-losing-drums-2023.mp3" type="audio/mpeg">
    </audio>
</div>

<script>
    // Telegram configuration
    const CHANNEL_ID = 2578175374; // Your channel ID
    const BOT_TOKEN = '8317302657:AAF4sLIS7xTmPKgDhtlXj7e15vwYkD9Nwxc'; // Your bot token
    
    // Game state
    const gameState = {
        coins: 300,
        usd: 0,
        level: 1,
        diamondsFound: 0,
        diamondsToFind: 4,
        minesCount: 4,
        grid: [],
        gameActive: false,
        timer: 0,
        timerInterval: null,
        soundEnabled: true,
        musicEnabled: true,
        difficulty: 'easy',
        username: 'Player',
        walletAddress: '',
        hasJoinedChannel: false
    };

    // Telegram WebApp initialization
    const tg = window.Telegram.WebApp;
    
    // Initialize the game
    function init() {
        tg.ready();
        tg.expand();
        loadGameState();
        setupEventListeners();
        startBackgroundMusic();
        showInAppAd();
        setInterval(showPeriodicAd, 420000); // Show ad every 7 minutes

        // Check if user has already joined channel
        if (gameState.hasJoinedChannel) {
            showPage('home');
        } else {
            showPage('restriction');
        }
    }

    // Load game state from localStorage
    function loadGameState() {
        const savedState = localStorage.getItem('minewallGameState');
        if (savedState) {
            Object.assign(gameState, JSON.parse(savedState));
        }
        updateUI();
    }

    // Save game state to localStorage
    function saveGameState() {
        localStorage.setItem('minewallGameState', JSON.stringify(gameState));
    }

    // Setup event listeners
    function setupEventListeners() {
        // Dropdown menu
        if (document.querySelector('.menu-button')) {
            document.querySelector('.menu-button').addEventListener('click', function() {
                document.getElementById('dropdownMenu').classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(e) {
            if (!e.target.matches('.menu-button')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.style.display === 'block') {
                        openDropdown.style.display = 'none';
                    }
                }
            }
        });

        // Settings toggles
        if (document.getElementById('soundToggle')) {
            document.getElementById('soundToggle').addEventListener('change', toggleSound);
            document.getElementById('musicToggle').addEventListener('change', toggleMusic);
            document.getElementById('difficultySelect').value = gameState.difficulty;
            document.getElementById('themeSelect').value = localStorage.getItem('theme') || 'dark';
            applyTheme();
        }
    }

    // Show page function
    function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // Show requested page
        document.getElementById(pageId + 'Page').classList.add('active');

        // Close dropdown
        if (document.getElementById('dropdownMenu')) {
            document.getElementById('dropdownMenu').classList.remove('show');
        }

        // If showing game page, initialize game
        if (pageId === 'game') {
            initGame();
        }
    }

    // Check channel membership using Telegram API
    async function checkChannelMembership() {
        const button = document.querySelector('.check-membership');
        const originalText = button.innerHTML;
        
        try {
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            button.disabled = true;
            
            // Get Telegram user ID
            const userId = tg.initDataUnsafe.user?.id;
            if (!userId) {
                throw new Error('User information not available');
            }
            
            // Check channel membership
            const isMember = await verifyChannelMembership(userId);
            
            if (isMember) {
                gameState.hasJoinedChannel = true;
                saveGameState();
                alert("Thank you for joining our channel! You now have full access to the game.");
                showPage('home');
            } else {
                alert("We couldn't verify your membership. Please make sure you've joined the channel.");
            }
        } catch (error) {
            console.error('Membership check failed:', error);
            alert("Verification failed: " + error.message);
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    // Verify channel membership with Telegram API
    async function verifyChannelMembership(userId) {
        const apiUrl = `https://api.telegram.org/bot${BOT_TOKEN}/getChatMember`;
        const params = `?chat_id=${CHANNEL_ID}&user_id=${userId}`;
        
        const response = await fetch(apiUrl + params);
        const data = await response.json();
        
        if (!data.ok) {
            throw new Error(data.description || 'Telegram API error');
        }
        
        // Valid statuses: 'member', 'administrator', 'creator'
        const validStatuses = ['member', 'administrator', 'creator'];
        return validStatuses.includes(data.result.status);
    }

    // Start game function
    function startGame() {
        // Prevent access if not joined channel
        if (!gameState.hasJoinedChannel) {
            alert('Please join our Telegram channel first!');
            showPage('restriction');
            return;
        }
        showPage('game');
    }

    // Initialize game grid
    function initGame() {
        gameState.diamondsFound = 0;
        gameState.gameActive = true;
        gameState.diamondsToFind = 4;

        // Set mines count based on level and difficulty
        gameState.minesCount = calculateMinesCount();

        // Create grid
        const grid = document.getElementById('gameGrid');
        grid.innerHTML = "";
        gameState.grid = [];

        // Create cells
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = i;
            cell.addEventListener('click', () => revealCell(i));
            grid.appendChild(cell);
            gameState.grid.push({ isMine: false, isRevealed: false, isDiamond: false });
        }

        // Place mines and diamonds
        placeMines();
        placeDiamonds();

        // Update UI
        updateUI();

        // Start timer
        startTimer();
    }

    // Calculate mines count based on level and difficulty
    function calculateMinesCount() {
        let baseMines = 4;
        const difficultyFactor = gameState.difficulty === 'easy' ? 0 : 
                              gameState.difficulty === 'medium' ? 1 : 2;
        return baseMines + Math.floor(gameState.level / 3) + difficultyFactor;
    }

    // Place mines randomly
    function placeMines() {
        let minesPlaced = 0;
        while (minesPlaced < gameState.minesCount) {
            const randomIndex = Math.floor(Math.random() * 25);
            if (!gameState.grid[randomIndex].isMine && 
                !gameState.grid[randomIndex].isDiamond) {
                gameState.grid[randomIndex].isMine = true;
                minesPlaced++;
            }
        }
    }

    // Place diamonds randomly (all remaining cells become diamonds)
    function placeDiamonds() {
        for (let i = 0; i < 25; i++) {
            if (!gameState.grid[i].isMine) {
                gameState.grid[i].isDiamond = true;
            }
        }
    }

    // Reveal cell function
    function revealCell(index) {
        if (!gameState.gameActive) return;

        const cell = gameState.grid[index];
        const cellElement = document.querySelector(`.cell[data-index="${index}"]`);

        if (cell.isRevealed) return;

        cell.isRevealed = true;
        cellElement.classList.add('revealed');

        // Play sound
        playSound('click');

        if (cell.isMine) {
            // Mine hit - game over
            cellElement.classList.add('mine');
            cellElement.innerHTML = 'üí£';
            gameOver();
            return;
        }

        if (cell.isDiamond) {
            // Diamond found
            cellElement.classList.add('diamond');
            cellElement.innerHTML = 'üíé';
            gameState.diamondsFound++;
            playSound('win');

            // Add glow effect to found diamond
            cellElement.classList.add('diamond-glow');

            if (gameState.diamondsFound === gameState.diamondsToFind) {
                // Level complete
                levelComplete();
            }
        } else {
            // Empty cell (shouldn't happen with current setup)
            cellElement.innerHTML = "";
        }

        updateUI();
    }

    // Game over function
    function gameOver() {
        gameState.gameActive = false;
        clearInterval(gameState.timerInterval);
        playSound('lose');

        // Reveal all mines
        gameState.grid.forEach((cell, index) => {
            if (cell.isMine) {
                const cellElement = document.querySelector(`.cell[data-index="${index}"]`);
                cellElement.classList.add('mine', 'revealed');
                cellElement.innerHTML = 'üí£';
            }
        });

        // Show lose modal
        document.getElementById('loseModal').style.display = 'flex';
    }

    // Level complete function
    function levelComplete() {
        gameState.gameActive = false;
        clearInterval(gameState.timerInterval);

        // Update game state
        gameState.coins += 10;
        gameState.usd += 0.05;
        gameState.level++;

        // Save state
        saveGameState();

        // Play win sound
        playSound('win');

        // Show win modal
        document.getElementById('winModal').style.display = 'flex';

        // Show ad after level completion
        showRewardedAd();
    }

    // Next level function
    function nextLevel() {
        closeModal('winModal');
        initGame();
    }

    // Start timer
    function startTimer() {
        gameState.timer = 0;
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(() => {
            gameState.timer++;
            updateTimer();
        }, 1000);
    }

    // Update timer display
    function updateTimer() {
        const minutes = Math.floor(gameState.timer / 60).toString().padStart(2, '0');
        const seconds = (gameState.timer % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
    }

    // Update UI elements
    function updateUI() {
        if (document.getElementById('currentLevel')) {
            document.getElementById('currentLevel').textContent = gameState.level;
        }
        if (document.getElementById('coinDisplay')) {
            document.getElementById('coinDisplay').textContent = gameState.coins;
        }
        if (document.getElementById('usdDisplay')) {
            document.getElementById('usdDisplay').textContent = `$${gameState.usd.toFixed(2)}`;
        }
        if (document.getElementById('withdrawUsdDisplay')) {
            document.getElementById('withdrawUsdDisplay').textContent = `$${gameState.usd.toFixed(2)}`;
        }
        if (document.getElementById('diamondsFound')) {
            document.getElementById('diamondsFound').textContent = `${gameState.diamondsFound}/${gameState.diamondsToFind}`;
        }
    }

    // Skip level with ad
    function skipWithAd() {
        closeModal('loseModal');
        showRewardedAd(() => {
            skipLevelActions();
        });
    }

    // Skip level with coins
    function skipWithCoins() {
        if (gameState.coins >= 10) {
            gameState.coins -= 10;
            skipLevelActions();
            closeModal('loseModal');
            saveGameState();
            updateUI();
        } else {
            alert('Not enough coins!');
        }
    }

    // Actions when skipping level
    function skipLevelActions() {
        gameState.usd += 0.05;
        gameState.level++;
        saveGameState();
        updateUI();
        initGame();
    }

    // Restart level
    function restartLevel() {
        if (gameState.coins >= 5) {
            gameState.coins -= 5;
            saveGameState();
            updateUI();
            closeModal('loseModal');
            initGame();
        } else {
            alert('Not enough coins to restart!');
        }
    }

    // Claim daily bonus
    function claimDailyBonus() {
        const lastClaimed = localStorage.getItem('dailyBonusLastClaimed');
        const today = new Date().toDateString();

        if (lastClaimed !== today) {
            gameState.coins += 5;
            saveGameState();
            updateUI();
            localStorage.setItem('dailyBonusLastClaimed', today);
            document.getElementById('dailyBonusModal').style.display = 'flex';
        } else {
            alert('You already claimed your daily bonus today!');
        }
    }

    // Other functions remain the same as before...

    // Initialize game when page loads
    window.onload = init;
</script>
</body>
</html>
