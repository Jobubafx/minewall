<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Minezwall - Telegram Mini App</title> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
    <style> 
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        } 
        body { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c); 
            color: white; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-x: hidden; 
        } 
        .container { 
            max-width: 480px; 
            margin: 0 auto; 
            padding: 10px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        } 
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 10px; 
            background: rgba(0, 0, 0, 0.7); 
            border-radius: 15px; 
            margin-bottom: 10px; 
            position: relative; 
        } 
        .menu-button, .back-button { 
            background: #4e54c8; 
            border: none; 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        } 
        .daily-bonus { 
            background: linear-gradient(to right, #ff8a00, #da1b60); 
            border: none; 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
        } 
        .game-title { 
            text-align: center; 
            font-size: 28px; 
            font-weight: bold; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
            margin: 10px 0; 
            letter-spacing: 1px; 
        } 
        .page { 
            display: none; 
            flex: 1; 
            flex-direction: column; 
        } 
        .page.active { 
            display: flex; 
        } 
        .restriction-page { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            padding: 20px; 
            background: rgba(0, 0, 0, 0.8); 
            border-radius: 15px; 
            margin: 20px; 
        } 
        .restriction-icon { 
            font-size: 60px; 
            color: #ff4d4d; 
            margin-bottom: 20px; 
        } 
        .restriction-title { 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 15px; 
        } 
        .restriction-message { 
            font-size: 16px; 
            margin-bottom: 25px; 
            line-height: 1.5; 
        } 
        .telegram-button { 
            background: #0088cc; 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 30px; 
            cursor: pointer; 
            margin-top: 20px; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
            text-decoration: none; 
        } 
        .telegram-button:hover { 
            background: #0077b3; 
        } 
        .check-button { 
            background: linear-gradient(to right, #00c9ff, #92fe9d); 
            border: none; 
            color: #1a2a6c; 
            padding: 12px 25px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 30px; 
            cursor: pointer; 
            margin-top: 15px; 
            transition: all 0.3s; 
        } 
        .check-button:disabled { 
            opacity: 0.7; 
            cursor: not-allowed; 
        } 
        .ad-container { 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 10px; 
            padding: 10px; 
            margin: 10px 0; 
            text-align: center; 
            min-height: 100px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden; 
        } 
        .start-button { 
            background: linear-gradient(to right, #00c9ff, #92fe9d); 
            border: none; 
            color: #1a2a6c; 
            padding: 20px 40px; 
            font-size: 24px; 
            font-weight: bold; 
            border-radius: 50px; 
            margin: 20px auto; 
            cursor: pointer; 
            box-shadow: 0 8px 15px rgba(0,0,0,0.3); 
            transition: all 0.3s; 
        } 
        .start-button:hover { 
            transform: scale(1.05); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); 
        } 
        .username-display { 
            text-align: center; 
            font-size: 18px; 
            margin-top: 15px; 
            background: rgba(255,255,255,0.1); 
            padding: 8px 15px; 
            border-radius: 20px; 
            display: inline-block; 
            margin-left: auto; 
            margin-right: auto; 
        } 
        .game-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin: 20px auto; 
            width: 100%; 
            max-width: 350px; 
        } 
        .cell { 
            aspect-ratio: 1/1; 
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 20px; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            position: relative; 
            overflow: hidden; 
        } 
        .cell::before { 
            content: "?"; 
            position: absolute; 
            font-size: 24px; 
            color: rgba(255,255,255,0.7); 
        } 
        .cell.revealed { 
            background: rgba(255, 255, 255, 0.4); 
        } 
        .cell.revealed::before { 
            display: none; 
        } 
        .cell.mine { 
            background: #ff4d4d; 
        } 
        .cell.diamond { 
            background: #4dffb8; 
        } 
        .stats-bar { 
            display: flex; 
            justify-content: space-between; 
            background: rgba(0, 0, 0, 0.7); 
            padding: 12px; 
            border-radius: 15px; 
            margin: 10px 0; 
        } 
        .stat-item { 
            text-align: center; 
        } 
        .stat-label { 
            font-size: 12px; 
            opacity: 0.8; 
        } 
        .stat-value { 
            font-size: 18px; 
            font-weight: bold; 
        } 
        .game-controls { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 20px; 
            gap: 10px; 
        } 
        .control-button { 
            flex: 1; 
            padding: 12px; 
            border-radius: 10px; 
            border: none; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
        } 
        .skip-ad { 
            background: linear-gradient(to right, #ff8a00, #e52e71); 
        } 
        .skip-coin { 
            background: linear-gradient(to right, #00b09b, #96c93d); 
        } 
        .restart { 
            background: linear-gradient(to right, #1d976c, #93f9b9); 
        } 
        .withdraw-form { 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 20px 0; 
        } 
        .input-group { 
            margin-bottom: 15px; 
        } 
        .input-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-size: 14px; 
        } 
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            border: none; 
            background: rgba(255, 255, 255, 0.9); 
        } 
        .submit-button { 
            background: linear-gradient(to right, #00c9ff, #92fe9d); 
            border: none; 
            color: #1a2a6c; 
            padding: 15px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 10px; 
            width: 100%; 
            cursor: pointer; 
            margin-top: 10px; 
        } 
        .settings-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 10px; 
            margin-bottom: 10px; 
        } 
        .toggle-switch { 
            position: relative; 
            display: inline-block; 
            width: 50px; 
            height: 24px; 
        } 
        .toggle-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        } 
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 24px; 
        } 
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 16px; 
            width: 16px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        } 
        input:checked + .slider { 
            background: linear-gradient(to right, #00c9ff, #92fe9d); 
        } 
        input:checked + .slider:before { 
            transform: translateX(26px); 
        } 
        .dropdown { 
            position: relative; 
            display: inline-block; 
        } 
        .dropdown-content { 
            display: none; 
            position: absolute; 
            background: rgba(0, 0, 0, 0.9); 
            min-width: 160px; 
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); 
            z-index: 1; 
            border-radius: 10px; 
            overflow: hidden; 
            top: 50px; 
            left: 0; 
        } 
        .dropdown-content button { 
            color: white; 
            padding: 12px 16px; 
            text-decoration: none; 
            display: block; 
            width: 100%; 
            text-align: left; 
            background: none; 
            border: none; 
            cursor: pointer; 
            transition: background 0.3s; 
        } 
        .dropdown-content button:hover { 
            background: rgba(78, 84, 200, 0.7); 
        } 
        .dropdown.show .dropdown-content { 
            display: block; 
        } 
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        } 
        .modal-content { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f); 
            padding: 30px; 
            border-radius: 20px; 
            text-align: center; 
            max-width: 90%; 
            width: 350px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        } 
        .modal h2 { 
            font-size: 28px; 
            margin-bottom: 20px; 
            color: #fff; 
        } 
        .modal p { 
            font-size: 18px; 
            margin-bottom: 25px; 
            line-height: 1.5; 
        } 
        .modal-button { 
            background: linear-gradient(to right, #00c9ff, #92fe9d); 
            border: none; 
            color: #1a2a6c; 
            padding: 12px 25px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 30px; 
            cursor: pointer; 
            margin: 0 5px; 
            transition: all 0.3s; 
        } 
        .modal-button:hover { 
            transform: scale(1.05); 
        } 
        .withdrawal-success-modal { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f); 
            padding: 30px; 
            border-radius: 20px; 
            text-align: center; 
            max-width: 90%; 
            width: 350px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        } 
        .form-redirect-button { 
            background: #0088cc; 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 30px; 
            cursor: pointer; 
            margin-top: 20px; 
            text-decoration: none; 
            display: inline-block; 
        } 
        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        } 
        .pulse { 
            animation: pulse 2s infinite; 
        } 
        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
            40% {transform: translateY(-20px);} 
            60% {transform: translateY(-10px);} 
        } 
        .bounce { 
            animation: bounce 1s; 
        } 
        @keyframes diamondGlow { 
            0% { box-shadow: 0 0 5px #4dffb8; } 
            50% { box-shadow: 0 0 20px #4dffb8; } 
            100% { box-shadow: 0 0 5px #4dffb8; } 
        } 
        .diamond-glow { 
            animation: diamondGlow 1.5s infinite; 
        } 
        .footer { 
            text-align: center; 
            padding: 15px; 
            font-size: 12px; 
            opacity: 0.7; 
        } 
        @media (max-width: 480px) { 
            .game-grid { 
                gap: 6px; 
            } 
            .control-button { 
                font-size: 14px; 
                padding: 10px; 
            } 
            .game-title { 
                font-size: 24px; 
            } 
            .start-button { 
                padding: 15px 30px; 
                font-size: 20px; 
            } 
        } 
        /* New styles for admin and redeem pages */ 
        .admin-list { 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto; 
        } 
        .admin-user { 
            background: rgba(255,255,255,0.1); 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 10px; 
        } 
        .admin-edit-form { 
            margin-top: 20px; 
        } 
        .redeem-form { 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 20px 0; 
        } 
    </style> 
</head> 
<body> 
    <script src='//libtl.com/sdk.js' data-zone='9662480' data-sdk='show_9662480'></script> 
 
    <div class="container"> 
        <div class="header"> 
            <div class="header-left" id="headerLeft"> 
                <div class="dropdown" id="dropdownMenu"> 
                    <button class="menu-button">☰</button> 
                    <div class="dropdown-content" id="dropdownContent"> 
                        <button onclick="showPage('withdraw')">Withdraw</button> 
                        <button onclick="showPage('redeem')">Redeem Code</button> 
                        <button onclick="showPage('settings')">Settings</button> 
                        <button onclick="showPage('referral')">Refer Friends</button>
                        <button onclick="showPage('faq')">FAQ & Instructions</button>
                    </div> 
                </div> 
            </div> 
            <div class="header-center" id="headerCenter"> 
                <div class="game-title">Minezwall</div> 
            </div> 
            <div class="header-right" id="headerRight"> 
                <button class="daily-bonus" onclick="claimDailyBonus()">Daily Bonus</button> 
            </div> 
        </div> 
         
        <div id="restrictionPage" class="page active"> 
            <div class="restriction-page"> 
                <div class="restriction-icon"> 
                    <i class="fas fa-exclamation-triangle"></i> 
                </div> 
                <h2 class="restriction-title">Access Restricted</h2> 
                <p class="restriction-message"> 
                    To play Minezwall and start earning, you must join our official Telegram channel first. 
                    After joining, please click the verification button below. 
                </p> 
                <a href="https://t.me/minezwallofficial" class="telegram-button" target="_blank"> 
                    <i class="fab fa-telegram"></i> Join Channel 
                </a> 
                <button class="check-button" onclick="verifyChannelJoin()"> 
                    <i class="fas fa-check-circle"></i> I've Joined 
                </button> 
            </div> 
        </div> 
         
        <div id="homePage" class="page"> 
            <h1 class="game-title">MINEZWALL</h1> 
            <div class="username-display" id="userDisplay">Welcome, Player!</div> 
            <button class="start-button pulse" onclick="startGame()">START GAME</button> 
        </div> 
         
        <div id="gamePage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">Level: <span id="currentLevel">1</span></div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
             
            <div class="stats-bar"> 
                <div class="stat-item"> 
                    <div class="stat-label">COINS</div> 
                    <div class="stat-value" id="coinDisplay">500</div> 
                </div> 
                <div class="stat-item"> 
                    <div class="stat-label">USD BALANCE</div> 
                    <div class="stat-value" id="usdDisplay">$0.000</div> 
                </div> 
                <div class="stat-item"> 
                    <div class="stat-label">DIAMONDS FOUND</div> 
                    <div class="stat-value" id="diamondsFound">0/4</div> 
                </div> 
            </div> 
             
            <div class="game-grid" id="gameGrid"></div> 
             
            <div class="game-controls"> 
                <button class="control-button skip-ad" onclick="skipWithAd()"> 
                    <i class="fas fa-ad"></i> Skip with Ad 
                </button> 
                <button class="control-button skip-coin" onclick="skipWithCoins()"> 
                    <i class="fas fa-coins"></i> Skip with Coins 
                </button> 
                <button class="control-button restart" onclick="restartLevel()"> 
                    <i class="fas fa-redo"></i> Restart 
                </button> 
            </div> 
        </div> 
         
        <div id="withdrawPage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">Withdraw</div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
             
            <div class="stats-bar"> 
                <div class="stat-item"> 
                    <div class="stat-label">USD BALANCE</div> 
                    <div class="stat-value" id="withdrawUsdDisplay">$0.000</div> 
                </div> 
            </div> 
             
            <div class="withdraw-form"> 
                <div class="input-group"> 
                    <label for="withdrawName">Full Name</label> 
                    <input type="text" id="withdrawName" placeholder="Enter your full name"> 
                </div> 
                 
                <div class="input-group"> 
                    <label for="withdrawAmount">Amount to Withdraw (USD)</label> 
                    <input type="number" id="withdrawAmount" placeholder="Minimum $5.00" min="5" step="0.001"> 
                </div> 
                 
                <div class="input-group"> 
                    <label for="withdrawMethod">Withdrawal Method</label> 
                    <select id="withdrawMethod"> 
                        <option value="usdt">USDT (Polygon Network)</option> 
                        <option value="btc">Bitcoin</option> 
                        <option value="eth">Ethereum</option> 
                    </select> 
                </div> 
                 
                <div class="input-group"> 
                    <label for="walletAddress">Wallet Address</label> 
                    <input type="text" id="walletAddress" placeholder="Enter your wallet address"> 
                </div> 
                 
                <button class="submit-button" onclick="processWithdrawal()">Withdraw Funds</button> 
            </div> 
        </div> 
         
        <div id="redeemPage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">Redeem Code</div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
            <div class="redeem-form">
                <div class="input-group">
                    <label for="redeemCode">Enter Redeem Code</label>
                    <input type="text" id="redeemCode" placeholder="Enter code here">
                </div>
                <button class="submit-button" onclick="redeemUserCode()">Redeem</button>
            </div>
        </div> 
         
        <div id="settingsPage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">Settings</div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
            <div class="settings-form" style="background: rgba(0, 0, 0, 0.6); border-radius: 15px; padding: 20px; margin: 20px 0;">
                <div class="settings-item">
                    <span>Sound</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Notifications</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
         
        <div id="referralPage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">Refer Friends</div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
             
            <div class="stats-bar"> 
                <div class="stat-item"> 
                    <div class="stat-label">REFERRAL COUNT</div> 
                    <div class="stat-value" id="referralCount">0</div> 
                </div> 
            </div> 
             
            <div style="background: rgba(0, 0, 0, 0.6); border-radius: 15px; padding: 20px; margin: 20px 0;"> 
                <p>Your referral link:</p> 
                <input type="text" id="referralLink" readonly style="width:100%; padding:12px; border-radius:10px; border:none; background:rgba(255,255,255,0.9); margin-bottom:15px;"> 
                <button class="submit-button" style="width:auto;" onclick="copyReferralLink()">Copy Link</button> 
                <p>Share this link with friends. When they join and start playing, your referral count will increase.</p> 
                <p>To claim your referral rewards, contact the admin who will generate a secret code for you to redeem through the Redeem Code section.</p> 
            </div> 
        </div> 
        
        <div id="faqPage" class="page"> 
            <div class="header"> 
                <div class="header-left"> 
                    <button class="back-button" onclick="showPage('home')">←</button> 
                </div> 
                <div class="header-center"> 
                    <div class="game-title">FAQ & Instructions</div> 
                </div> 
                <div class="header-right"></div> 
            </div> 
             
            <div style="background: rgba(0, 0, 0, 0.6); border-radius: 15px; padding: 20px; margin: 20px 0; overflow-y: auto;"> 
                <h3>How to Play the Game</h3> 
                <p>Minezwall is a thrilling mining adventure game played on a 5x5 grid. Your objective is to uncover 4 diamonds while avoiding mines. Tap on cells to reveal their contents:</p> 
                <ul> 
                    <li><strong>Diamond:</strong> Earn coins or USD rewards and progress towards completing the level.</li> 
                    <li><strong>Mine:</strong> Hitting a mine ends the current level attempt, and you'll need to restart or skip.</li> 
                </ul> 
                <p>Use controls like "Skip with Ad", "Skip with Coins", or "Restart" if needed. Complete levels to advance and earn more.</p> 
                 
                <h3>Navigating Other Features</h3> 
                <p>Use the menu button (☰) in the header to access:</p> 
                <ul> 
                    <li><strong>Withdraw:</strong> Cash out your USD balance (minimum $5). Enter your details and submit.</li> 
                    <li><strong>Redeem Code:</strong> Enter provided codes to claim bonuses like coins or USD.</li> 
                    <li><strong>Settings:</strong> Adjust preferences such as sound, notifications, etc.</li> 
                    <li><strong>Refer Friends:</strong> Share your referral link to invite others. Track your referral count here.</li> 
                    <li><strong>FAQ & Instructions:</strong> This page for help and guides.</li> 
                </ul> 
                <p>Claim daily bonuses from the header button.</p> 
                 
                <h3>Frequently Asked Questions (FAQ)</h3> 
                <p><strong>Q: How do I start playing?</strong> A: Join the channel, verify, then click "START GAME" on the home page.</p> 
                <p><strong>Q: What happens if I hit a mine?</strong> A: You lose progress on the current level but can restart or skip.</p> 
                <p><strong>Q: How are rewards calculated?</strong> A: Diamonds give random coin/USD rewards based on level.</p> 
                <p><strong>Q: Can I withdraw anytime?</strong> A: Yes, if balance >= $5, using supported methods like USDT, BTC, ETH.</p> 
                <p><strong>Q: How do referrals work?</strong> A: Share your link. Admin provides redeem codes for rewards after referrals join.</p> 
                <p><strong>Q: App is slow?</strong> A: Ensure good internet; clear cache if needed. Updates may improve performance.</p> 
            </div> 
        </div> 

        <div id="modal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle"></h2>
                <p id="modalText"></p>
                <button class="modal-button" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div> 
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        const user = tg.initDataUnsafe.user || {id: 'test', first_name: 'Test', username: 'testuser'};
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRuGkinnr3uD5Vp32gBSuUF7htofMhPLs9D5ivd2_4cgvOrh4CVGTRkvDwOwKFLkgi/exec'; // Replace with actual deployment ID

        let coins = 500;
        let usd = 0;
        let currentLevel = 1;
        let diamondsFound = 0;
        let diamonds = [];
        let mines = [];
        let referralCode = '';
        let referralCount = 0;

        document.getElementById('userDisplay').innerText = `Welcome, ${user.first_name}!`;

        document.querySelector('.menu-button').addEventListener('click', () => {
            document.getElementById('dropdownMenu').classList.toggle('show');
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.matches('.menu-button')) {
                document.querySelectorAll('.dropdown.show').forEach(d => d.classList.remove('show'));
            }
        });

        async function loadUserData() {
            const response = await fetch(`${SCRIPT_URL}?action=getUserData&userId=${user.id}`);
            const data = await response.json();
            if (data.success) {
                coins = data.user.coins;
                usd = data.user.usd;
                referralCode = data.user.referralCode;
                referralCount = data.user.referralCount;
                if (data.user.channelJoined) {
                    showPage('home');
                }
                updateStats();
            } else {
                // Register new user
                await registerUser();
                loadUserData();
            }
        }

async function registerUser() {
            const params = new URLSearchParams({
                action: 'registerUser',
                userId: user.id,
                username: user.username || '',
                fullName: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                coins: 500,
                usd: 0,
                channelJoined: true
            });
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const data = await response.json();
            if (data.success) {
                referralCode = data.referralCode;
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`${pageId}Page`).classList.add('active');
            if (pageId === 'game') {
                document.getElementById('currentLevel').innerText = currentLevel;
            } else if (pageId === 'withdraw') {
                document.getElementById('withdrawUsdDisplay').innerText = `$${usd.toFixed(3)}`;
            } else if (pageId === 'referral') {
                document.getElementById('referralCount').innerText = referralCount;
                document.getElementById('referralLink').value = `https://t.me/minezwallbot?startapp=${referralCode}`;
            }
        }

        async function verifyChannelJoin() {
            const response = await fetch(`${SCRIPT_URL}?action=checkChannel&userId=${user.id}`);
            const data = await response.json();
            if (data.isMember) {
                showPage('home');
            } else {
                tg.showAlert('Please join the channel first.');
            }
        }

        function startGame() {
            showPage('game');
            generateGrid();
            updateStats();
        }

        function generateGrid() {
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = '';
            const positions = [...Array(25).keys()];
            shuffle(positions);
            diamonds = positions.slice(0, 4);
            mines = positions.slice(4, 9);
            diamondsFound = 0;
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.addEventListener('click', () => revealCell(i));
                grid.appendChild(cell);
            }
            document.getElementById('diamondsFound').innerText = `${diamondsFound}/4`;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function revealCell(index) {
            const grid = document.getElementById('gameGrid');
            const cell = grid.children[index];
            if (cell.classList.contains('revealed')) return;
            cell.classList.add('revealed');
            if (mines.includes(index)) {
                cell.classList.add('mine');
                showModal('Boom!', 'You hit a mine! Try restarting or skipping the level.');
            } else if (diamonds.includes(index)) {
                cell.classList.add('diamond');
                diamondsFound++;
                coins += Math.floor(Math.random() * 20) + 10;
                usd += (Math.random() * 0.01).toFixed(3);
                if (diamondsFound === 4) {
                    showModal('Level Complete!', 'Great job! Moving to next level.');
                    currentLevel++;
                    document.getElementById('currentLevel').innerText = currentLevel;
                    generateGrid();
                }
            }
            updateStats();
            await updateUserBalance(0, 0); // Sync with server
        }

        function updateStats() {
            document.getElementById('coinDisplay').innerText = coins;
            document.getElementById('usdDisplay').innerText = `$${parseFloat(usd).toFixed(3)}`;
            document.getElementById('diamondsFound').innerText = `${diamondsFound}/4`;
            document.getElementById('withdrawUsdDisplay').innerText = `$${parseFloat(usd).toFixed(3)}`;
        }

        function skipWithAd() {
            // Simulate ad show
            tg.showAlert('Ad watched! Skipping level.');
            currentLevel++;
            generateGrid();
        }

        async function skipWithCoins() {
            if (coins < 50) {
                tg.showAlert('Not enough coins!');
                return;
            }
            coins -= 50;
            currentLevel++;
            generateGrid();
            updateStats();
            await updateUserBalance(-50, 0);
        }

        function restartLevel() {
            generateGrid();
        }

        async function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            if (amount < 5 || amount > usd) {
                tg.showAlert('Invalid amount!');
                return;
            }
            // Simulate withdrawal
            usd -= amount;
            updateStats();
            await updateUserBalance(0, -amount);
            tg.showAlert('Withdrawal requested successfully!');
        }

        async function redeemUserCode() {
            const code = document.getElementById('redeemCode').value;
            const response = await fetch(`${SCRIPT_URL}?action=redeemCode&userId=${user.id}&code=${code}`);
            const data = await response.json();
            if (data.success) {
                if (data.type === 'coin') {
                    coins += data.value;
                } else if (data.type === 'usd') {
                    usd += data.value;
                }
                updateStats();
                tg.showAlert(`Redeemed ${data.value} ${data.type}!`);
            } else {
                tg.showAlert(data.message || 'Invalid code!');
            }
        }

        async function claimDailyBonus() {
            // Assume 100 coins daily
            coins += 100;
            updateStats();
            await updateUserBalance(100, 0);
            tg.showAlert('Daily bonus claimed: 100 coins!');
        }

        async function updateUserBalance(coinsChange, usdChange) {
            const params = new URLSearchParams({
                action: 'updateBalance',
                targetUserId: user.id,
                coinsChange: coinsChange,
                usdChange: usdChange
            });
            await fetch(`${SCRIPT_URL}?${params.toString()}`);
            // Update local to latest from server if needed, but for simplicity skip
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLink');
            linkInput.select();
            document.execCommand('copy');
            tg.showAlert('Referral link copied!');
        }

        function showModal(title, text) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalText').innerText = text;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Load user data on start
        window.addEventListener('load', () => {
            tg.expand();
            loadUserData();
        });

        // Handle referral if started with startapp
        const startParam = tg.initDataUnsafe.start_param;
        if (startParam) {
            fetch(`${SCRIPT_URL}?action=registerReferral&userId=${user.id}&referredBy=${startParam}`);
        }
    </script>
</body> 
</html>
