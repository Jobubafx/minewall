<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minezwall</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; background: linear-gradient(135deg, #1a2a6c, #b21f1f); color: white; font-family: Arial; }
        .container { max-width: 480px; margin: auto; padding: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.7); border-radius: 10px; }
        .menu-button { background: #4e54c8; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .daily-bonus { background: linear-gradient(to right, #ff8a00, #da1b60); color: white; padding: 8px 15px; border-radius: 20px; border: none; cursor: pointer; }
        .game-title { font-size: 24px; font-weight: bold; text-align: center; }
        .page { display: none; flex-direction: column; }
        .page.active { display: flex; }
        .restriction-page { text-align: center; padding: 20px; background: rgba(0, 0, 0, 0.8); border-radius: 10px; margin: 20px; }
        .restriction-icon { font-size: 50px; color: #ff4d4d; margin-bottom: 15px; }
        .telegram-button, .check-button, .submit-button { background: linear-gradient(to right, #00c9ff, #92fe9d); color: #1a2a6c; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; margin: 10px 0; text-decoration: none; }
        .check-button:disabled { opacity: 0.7; cursor: not-allowed; }
        .start-button { background: linear-gradient(to right, #00c9ff, #92fe9d); color: #1a2a6c; padding: 15px 30px; font-size: 20px; border-radius: 30px; margin: 20px auto; cursor: pointer; }
        .username-display { text-align: center; font-size: 16px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 20px; margin: 10px auto; }
        .game-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 20px auto; max-width: 300px; }
        .cell { aspect-ratio: 1/1; background: rgba(255, 255, 255, 0.2); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .cell::before { content: "?"; }
        .cell.revealed::before { display: none; }
        .cell.mine { background: #ff4d4d; }
        .cell.diamond { background: #4dffb8; }
        .stats-bar { display: flex; justify-content: space-between; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 10px; margin: 10px 0; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 12px; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .game-controls { display: flex; gap: 10px; margin-top: 20px; }
        .control-button { flex: 1; padding: 10px; border-radius: 10px; border: none; color: white; cursor: pointer; }
        .skip-ad { background: linear-gradient(to right, #ff8a00, #e52e71); }
        .skip-coin { background: linear-gradient(to right, #00b09b, #96c93d); }
        .restart { background: linear-gradient(to right, #1d976c, #93f9b9); }
        .withdraw-form, .redeem-form, .admin-panel { background: rgba(0, 0, 0, 0.6); border-radius: 10px; padding: 15px; margin: 20px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 14px; }
        .input-group input { width: 100%; padding: 10px; border-radius: 10px; border: none; }
        .admin-panel table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-panel th, .admin-panel td { padding: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background: rgba(0, 0, 0, 0.9); min-width: 120px; border-radius: 10px; top: 40px; left: 0; }
        .dropdown-content button { color: white; padding: 10px; width: 100%; text-align: left; background: none; border: none; cursor: pointer; }
        .dropdown-content button:hover { background: rgba(78, 84, 200, 0.7); }
        .dropdown.show .dropdown-content { display: block; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); align-items: center; justify-content: center; }
        .modal-content { background: linear-gradient(135deg, #1a2a6c, #b21f1f); padding: 20px; border-radius: 10px; text-align: center; max-width: 300px; }
        .modal-button { background: linear-gradient(to right, #00c9ff, #92fe9d); color: #1a2a6c; padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="dropdown" id="dropdownMenu">
                <button class="menu-button">‚ò∞</button>
                <div class="dropdown-content">
                    <button onclick="showPage('withdraw')">Withdraw</button>
                    <button onclick="showPage('redeem')">Redeem Code</button>
                    <button onclick="showPage('admin')" id="adminMenu" style="display: none;">Admin Panel</button>
                </div>
            </div>
            <div class="game-title">Minezwall</div>
            <button class="daily-bonus" onclick="claimDailyBonus()">Daily Bonus</button>
        </div>

        <div id="restrictionPage" class="page active">
            <div class="restriction-page">
                <div class="restriction-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <h2>Join Required</h2>
                <p>Join our Telegram channel to play.</p>
                <a href="https://t.me/minezwallofficial" class="telegram-button" target="_blank">Join Channel</a>
                <button class="check-button" onclick="verifyChannelJoin()">I've Joined</button>
            </div>
        </div>

        <div id="homePage" class="page">
            <h1 class="game-title">MINEZWALL</h1>
            <div class="username-display" id="userDisplay">Welcome, Player!</div>
            <button class="start-button" onclick="startGame()">START GAME</button>
        </div>

        <div id="gamePage" class="page">
            <div class="header">
                <button class="back-button" onclick="showPage('home')">‚Üê</button>
                <div class="game-title">Level: <span id="currentLevel">1</span></div>
                <div></div>
            </div>
            <div class="stats-bar">
                <div class="stat-item"><div class="stat-label">COINS</div><div class="stat-value" id="coinDisplay">500</div></div>
                <div class="stat-item"><div class="stat-label">USD</div><div class="stat-value" id="usdDisplay">$0.500</div></div>
                <div class="stat-item"><div class="stat-label">DIAMONDS</div><div class="stat-value" id="diamondsFound">0/20</div></div>
            </div>
            <div class="game-grid" id="gameGrid"></div>
            <div class="game-controls">
                <button class="control-button skip-ad" onclick="skipWithAd()">Skip with Ad</button>
                <button class="control-button skip-coin" onclick="skipWithCoins()">Skip with Coins</button>
                <button class="control-button restart" onclick="restartLevel()">Restart</button>
            </div>
        </div>

        <div id="withdrawPage" class="page">
            <div class="header">
                <button class="back-button" onclick="showPage('home')">‚Üê</button>
                <div class="game-title">Withdraw</div>
                <div></div>
            </div>
            <div class="stats-bar">
                <div class="stat-item"><div class="stat-label">USD</div><div class="stat-value" id="withdrawUsdDisplay">$0.500</div></div>
            </div>
            <div class="withdraw-form">
                <div class="input-group">
                    <label for="withdrawName">Full Name</label>
                    <input type="text" id="withdrawName" placeholder="Enter your full name">
                </div>
                <div class="input-group">
                    <label for="withdrawAmount">Amount (USD)</label>
                    <input type="number" id="withdrawAmount" placeholder="Min $5.00" min="5" step="0.001">
                </div>
                <div class="input-group">
                    <label for="walletAddress">Wallet Address</label>
                    <input type="text" id="walletAddress" placeholder="Enter wallet address">
                </div>
                <button class="submit-button" onclick="processWithdrawal()">Withdraw</button>
            </div>
        </div>

        <div id="redeemPage" class="page">
            <div class="header">
                <button class="back-button" onclick="showPage('home')">‚Üê</button>
                <div class="game-title">Redeem Code</div>
                <div></div>
            </div>
            <div class="redeem-form">
                <div class="input-group">
                    <label for="redeemCode">Enter Code</label>
                    <input type="text" id="redeemCode" placeholder="Enter secret code">
                </div>
                <button class="submit-button" onclick="redeemCode()">Redeem</button>
            </div>
        </div>

        <div id="adminPage" class="page">
            <div class="header">
                <button class="back-button" onclick="showPage('home')">‚Üê</button>
                <div class="game-title">Admin Panel</div>
                <div></div>
            </div>
            <div class="admin-panel">
                <h2>Generate Code</h2>
                <div class="input-group">
                    <label for="codeCoins">Coins</label>
                    <input type="number" id="codeCoins" placeholder="Coins amount">
                </div>
                <div class="input-group">
                    <label for="codeUsd">USD</label>
                    <input type="number" id="codeUsd" placeholder="USD amount" step="0.001">
                </div>
                <button class="submit-button" onclick="generateCode()">Generate</button>
                <h2>Manage Users</h2>
                <table id="userTable">
                    <thead><tr><th>User ID</th><th>Username</th><th>Coins</th><th>USD</th><th>Action</th></tr></thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="modal" id="winModal">
            <div class="modal-content">
                <h2>Congratulations!</h2>
                <p>You found all diamonds!</p>
                <button class="modal-button" onclick="nextLevel()">Next Level</button>
            </div>
        </div>

        <div class="modal" id="loseModal">
            <div class="modal-content">
                <h2>Game Over!</h2>
                <p>You hit a mine.</p>
                <button class="modal-button skip-ad" onclick="skipWithAd()">Skip with Ad</button>
                <button class="modal-button skip-coin" onclick="skipWithCoins()">Skip with Coins</button>
                <button class="modal-button restart" onclick="restartLevel()">Restart</button>
            </div>
        </div>

        <div class="modal" id="dailyBonusModal">
            <div class="modal-content">
                <h2>Daily Bonus!</h2>
                <p>You got 50 coins!</p>
                <button class="modal-button" onclick="closeModal('dailyBonusModal')">Claim</button>
            </div>
        </div>

        <div class="modal" id="withdrawalSuccessModal">
            <div class="modal-content">
                <h2>Withdrawal Requested!</h2>
                <p>Your request was submitted.</p>
                <button class="modal-button" onclick="closeModal('withdrawalSuccessModal')">OK</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const ADMIN_USER_ID = "1558798885";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMI_IlhX5FpnVrN0A1lUMJemSecB5vp6POkn5whgpXDYbgTYUMCpKxr1jCPH382k_K/exec"; // Replace with your Google Apps Script Web app URL

        const gameState = {
            coins: 500,
            usd: 0.5,
            level: 1,
            diamondsFound: 0,
            diamondsToFind: 20,
            minesCount: 5,
            grid: [],
            gameActive: false,
            userId: null,
            username: "Player",
            channelJoined: false,
        };

        async function init() {
            tg.expand();
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                gameState.userId = tg.initDataUnsafe.user.id.toString();
                gameState.username = tg.initDataUnsafe.user.username || `User${gameState.userId}`;
                document.getElementById("userDisplay").textContent = `Welcome, ${gameState.username}!`;
                if (gameState.userId === ADMIN_USER_ID) {
                    document.getElementById("adminMenu").style.display = "block";
                }
                await initializeUser();
            }
            await loadGameState();
            document.querySelector(".menu-button").addEventListener("click", () => {
                document.getElementById("dropdownMenu").classList.toggle("show");
            });
            window.addEventListener("click", e => {
                if (!e.target.matches(".menu-button")) {
                    document.getElementById("dropdownMenu").classList.remove("show");
                }
            });
            if (!gameState.channelJoined) showPage("restriction");
            else showPage("home");
        }

        async function initializeUser() {
            await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "initializeUser", userId: gameState.userId, username: gameState.username }),
                headers: { "Content-Type": "application/json" },
            });
        }

        async function loadGameState() {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getUser", userId: gameState.userId }),
                headers: { "Content-Type": "application/json" },
            });
            const user = await response.json();
            if (user && user.coins !== undefined) {
                gameState.coins = user.coins;
                gameState.usd = user.usd;
            }
            const verifyResponse = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "verifyChannel", userId: gameState.userId }),
                headers: { "Content-Type": "application/json" },
            });
            gameState.channelJoined = (await verifyResponse.json()).isMember;
            updateUI();
        }

        async function verifyChannelJoin() {
            const checkBtn = document.querySelector(".check-button");
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "verifyChannel", userId: gameState.userId }),
                headers: { "Content-Type": "application/json" },
            });
            const { isMember } = await response.json();
            checkBtn.disabled = false;
            checkBtn.innerHTML = "I've Joined";
            if (isMember) {
                gameState.channelJoined = true;
                showPage("home");
                alert("Welcome to Minezwall!");
            } else {
                alert("Please join the Telegram channel.");
            }
        }

        async function loadUsers() {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getUsers", adminId: gameState.userId }),
                headers: { "Content-Type": "application/json" },
            });
            const users = await response.json();
            const tableBody = document.getElementById("userTableBody");
            tableBody.innerHTML = "";
            users.forEach(user => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.username}</td>
                    <td><input type="number" value="${user.coins}" id="coins-${user.userId}"></td>
                    <td><input type="number" step="0.001" value="${user.usd}" id="usd-${user.userId}"></td>
                    <td><button class="submit-button" onclick="updateUserBalance('${user.userId}')">Update</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function updateUserBalance(userId) {
            const coins = parseFloat(document.getElementById(`coins-${userId}`).value);
            const usd = parseFloat(document.getElementById(`usd-${userId}`).value);
            await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "updateBalance", adminId: gameState.userId, userId, coins, usd }),
                headers: { "Content-Type": "application/json" },
            });
            alert("Balance updated");
            loadUsers();
        }

        async function generateCode() {
            const coins = parseInt(document.getElementById("codeCoins").value);
            const usd = parseFloat(document.getElementById("codeUsd").value);
            if (!coins || !usd) {
                alert("Enter valid coins and USD");
                return;
            }
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "generateCode", adminId: gameState.userId, coins, usd }),
                headers: { "Content-Type": "application/json" },
            });
            const { code } = await response.json();
            alert(`Generated code: ${code}`);
        }

        async function redeemCode() {
            const code = document.getElementById("redeemCode").value;
            if (!code) {
                alert("Enter a code");
                return;
            }
            const response = await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "redeemCode", userId: gameState.userId, code }),
                headers: { "Content-Type": "application/json" },
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) await loadGameState();
        }

        function showPage(pageId) {
            if (pageId !== "restriction" && !gameState.channelJoined) {
                showPage("restriction");
                return;
            }
            if (pageId === "admin" && gameState.userId !== ADMIN_USER_ID) {
                alert("Access denied");
                return;
            }
            document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
            document.getElementById(pageId + "Page").classList.add("active");
            document.getElementById("dropdownMenu").classList.remove("show");
            if (pageId === "game") initGame();
            if (pageId === "admin") loadUsers();
        }

       function startGame() {
            if (!gameState.channelJoined) {
                showPage("restriction");
                alert("Join the Telegram channel to play.");
                return;
            }
            showPage("game");
        }

        function initGame() {
            gameState.diamondsFound = 0;
            gameState.gameActive = true;
            const grid = document.getElementById("gameGrid");
            grid.innerHTML = "";
            gameState.grid = [];
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.dataset.index = i;
                cell.addEventListener("click", () => revealCell(i));
                grid.appendChild(cell);
                gameState.grid.push({ isMine: false, isRevealed: false, isDiamond: false });
            }
            let minesPlaced = 0;
            while (minesPlaced < gameState.minesCount) {
                const idx = Math.floor(Math.random() * 25);
                if (!gameState.grid[idx].isMine) {
                    gameState.grid[idx].isMine = true;
                    minesPlaced++;
                }
            }
            gameState.grid.forEach(cell => {
                if (!cell.isMine) cell.isDiamond = true;
            });
            updateUI();
        }

        function revealCell(index) {
            if (!gameState.gameActive || gameState.grid[index].isRevealed) return;
            const cell = gameState.grid[index];
            const cellElement = document.querySelector(`.cell[data-index="${index}"]`);
            cell.isRevealed = true;
            cellElement.classList.add("revealed");
            if (cell.isMine) {
                cellElement.classList.add("mine");
                cellElement.innerHTML = "üí£";
                gameOver();
            } else if (cell.isDiamond) {
                cellElement.classList.add("diamond");
                cellElement.innerHTML = "üíé";
                gameState.diamondsFound++;
                if (gameState.diamondsFound === gameState.diamondsToFind) levelComplete();
            }
            updateUI();
        }

        function gameOver() {
            gameState.gameActive = false;
            gameState.grid.forEach((cell, index) => {
                if (cell.isMine) {
                    const cellElement = document.querySelector(`.cell[data-index="${index}"]`);
                    cellElement.classList.add("mine", "revealed");
                    cellElement.innerHTML = "üí£";
                }
            });
            document.getElementById("loseModal").style.display = "flex";
        }

        async function levelComplete() {
            if (gameState.coins <= 0) {
                alert("Not enough coins!");
                gameState.gameActive = false;
                return;
            }
            gameState.gameActive = false;
            gameState.coins -= 8;
            gameState.usd += 0.005;
            gameState.level++;
            await saveGameState();
            document.getElementById("winModal").style.display = "flex";
        }

        function nextLevel() {
            closeModal("winModal");
            initGame();
        }

        async function skipWithAd() {
            closeModal("loseModal");
            gameState.usd += 0.005;
            gameState.level++;
            await saveGameState();
            updateUI();
            initGame();
        }

        async function skipWithCoins() {
            if (gameState.coins >= 25) {
                gameState.coins -= 25;
                gameState.usd += 0.005;
                gameState.level++;
                await saveGameState();
                updateUI();
                closeModal("loseModal");
                initGame();
            } else {
                alert("Not enough coins!");
            }
        }

        async function restartLevel() {
            if (gameState.coins >= 5) {
                gameState.coins -= 5;
                await saveGameState();
                updateUI();
                closeModal("loseModal");
                initGame();
            } else {
                alert("Not enough coins!");
            }
        }

        async function claimDailyBonus() {
            const lastClaimed = localStorage.getItem("dailyBonusLastClaimed");
            const today = new Date().toDateString();
            if (lastClaimed !== today) {
                gameState.coins += 50;
                await saveGameState();
                localStorage.setItem("dailyBonusLastClaimed", today);
                document.getElementById("dailyBonusModal").style.display = "flex";
            } else {
                alert("Already claimed today!");
            }
        }

        async function processWithdrawal() {
            const name = document.getElementById("withdrawName").value;
            const amount = parseFloat(document.getElementById("withdrawAmount").value);
            const walletAddress = document.getElementById("walletAddress").value;
            if (!name || !amount || amount < 5 || amount > gameState.usd || !walletAddress) {
                alert("Invalid withdrawal details");
                return;
            }
            gameState.usd -= amount;
            await saveGameState();
            updateUI();
            document.getElementById("withdrawalSuccessModal").style.display = "flex";
        }

        async function saveGameState() {
            await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "updateBalance", adminId: gameState.userId, userId: gameState.userId, coins: gameState.coins, usd: gameState.usd }),
                headers: { "Content-Type": "application/json" },
            });
        }

        function updateUI() {
            document.getElementById("currentLevel").textContent = gameState.level;
            document.getElementById("coinDisplay").textContent = gameState.coins;
            document.getElementById("usdDisplay").textContent = `$${gameState.usd.toFixed(3)}`;
            document.getElementById("withdrawUsdDisplay").textContent = `$${gameState.usd.toFixed(3)}`;
            document.getElementById("diamondsFound").textContent = `${gameState.diamondsFound}/20`;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        window.onload = init;
    </script>
</body>
</html>
